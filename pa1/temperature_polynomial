import pandas as pd
import numpy as np
from sklearn.preprocessing import PolynomialFeatures
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
import matplotlib.pyplot as plt
import math

# === 1. BACA DATA ===
file_path = "data 3 bulan.xlsx"
df = pd.read_excel(file_path, sheet_name='Sheet1', header=None)
df.columns = ['Tavg']
data = df['Tavg'].values

# === 2. SIAPKAN DATA LAG ===
def create_lagged_features(data, lag=7):
    X, y = [], []
    for i in range(lag, len(data)):
        X.append(data[i-lag:i])
        y.append(data[i])
    return np.array(X), np.array(y)

lag = 7
X, y = create_lagged_features(data, lag)

# === 3. TRANSFORMASI POLINOMIAL ===
degree = 2  # ubah ke 3 untuk derajat lebih tinggi
poly = PolynomialFeatures(degree)
X_poly = poly.fit_transform(X)

# === 4. MODEL REGRESI LINIER ===
model = LinearRegression()
model.fit(X_poly, y)

# === 5. PREDIKSI 7 HARI PERTAMA APRIL ===
history = list(data[-lag:])
predictions = []

for _ in range(7):
    x_input = np.array(history[-lag:]).reshape(1, -1)
    x_poly = poly.transform(x_input)
    pred = model.predict(x_poly)[0]
    predictions.append(pred)
    history.append(pred)

# Tampilkan hasil prediksi
print("=== Prediksi Tavg (Autoregressive Polynomial) ===")
for i, val in enumerate(predictions, 1):
    print(f"Hari {i}: {val:.2f}")

# === 6. EVALUASI ===
actual_april = [30.5, 30.4, 30.3, 30.1, 29.8, 31.6, 31.3]

mse = mean_squared_error(actual_april, predictions)
rmse = math.sqrt(mse)
mae = mean_absolute_error(actual_april, predictions)
r2 = r2_score(actual_april, predictions)

print("\n=== Evaluasi Model ===")
print(f"MSE  : {mse:.4f}")
print(f"RMSE : {rmse:.4f}")
print(f"MAE  : {mae:.4f}")
print(f"R²   : {r2:.4f}")

# === 7. VISUALISASI ===
plt.figure(figsize=(10, 6))
days = np.arange(1, 8)

plt.plot(days, actual_april, marker='o', linestyle='-', label='Aktual', color='blue')
plt.plot(days, predictions, marker='o', linestyle='--', label='Prediksi Polynomial', color='purple')

plt.title("Prediksi vs Aktual Tavg (Autoregressive Polynomial Regression)")
plt.xlabel("Hari di Bulan April")
plt.ylabel("Tavg (°C)")
plt.xticks(days)
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()
