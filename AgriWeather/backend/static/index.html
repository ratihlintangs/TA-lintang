<!DOCTYPE html>
<html lang="id">
<head>
  <!-- ================= PWA ================= -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#059669">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="icon" href="/static/icons/icon-192.png">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgriWeather - Ramalan Cuaca 7 Hari</title>

  <!-- ================= TAILWIND ================= -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#059669',
            secondary: '#34D399',
            background: '#F9FAFB',
            card: '#FFFFFF',
            accent: '#10B981',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>

  <!-- ================= FONT ================= -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  </style>
</head>

<body class="bg-background min-h-screen font-sans p-4 sm:p-8">

  <div class="max-w-6xl mx-auto">

    <!-- ================= HEADER ================= -->
    <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-lg">
      <h1 class="text-4xl font-bold text-primary mb-2">AgriWeather</h1>
      <p class="text-gray-600 text-lg">
        Ramalan Cuaca Harian untuk 7 Hari ke Depan (Model MLP Time Series)
      </p>
      <p class="text-sm font-semibold text-accent mt-3">
        üìç Lokasi Prediksi: Stasiun Klimatologi Karangploso (BMKG)
      </p>
    </header>

    <!-- ================= FORECAST ================= -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-gray-700 mb-4">
        Ramalan 7 Hari Ke Depan
      </h2>

      <div id="loading" class="p-6 bg-blue-100 text-blue-800 rounded-lg text-center">
        ‚è≥ Memuat data ramalan cuaca...
      </div>

      <div id="error" class="hidden p-6 bg-red-100 text-red-800 rounded-lg text-center">
        ‚ùå Gagal memuat data dari server.
      </div>

      <div id="featured-forecast" class="mt-6"></div>
      <div id="forecast-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6"></div>
    </section>

    <!-- ================= EVALUATION ================= -->
    <section id="evaluation-section" class="hidden p-6 bg-white rounded-xl shadow-lg">
      <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">
        Evaluasi Kinerja Model
      </h2>
      <div id="evaluation-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

  </div>

  <script>
    /* ================= API ENDPOINT ================= */
    const FORECAST_ENDPOINT = `/weather/forecast`;
    const EVALUATION_ENDPOINT = `/weather/evaluation-history/latest?horizon_days=7`;

    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("error");
    const featuredEl = document.getElementById("featured-forecast");
    const forecastGrid = document.getElementById("forecast-grid");
    const evalSection = document.getElementById("evaluation-section");
    const evalCards = document.getElementById("evaluation-cards");

    /* ================= HELPERS ================= */
    function safeFixed(value, digits) {
      if (value === null || value === undefined || value === "") return "-";
      const num = Number(value);
      if (!Number.isFinite(num)) return "-";
      return num.toFixed(digits);
    }

    function splitHariTanggal(dateStr) {
      const d = new Date(dateStr);
      return {
        hari: d.toLocaleDateString("id-ID", { weekday: "long" }),
        tanggal: d.toLocaleDateString("id-ID", { day: "numeric", month: "long", year: "numeric" })
      };
    }

    function classifyWeather(item) {
      const T = Number(item.temperature_c);
      const RH = Number(item.humidity_percent);
      const PS = Number(item.pressure_hpa);
      const WS = Number(item.wind_speed_kmh);

      if ([T, RH, PS, WS].some(v => Number.isNaN(v))) {
        return { label: "Tidak diketahui", icon: "‚ùì" };
      }

      if (RH > 85 && T < 27 && PS < 1008) return { label: "Hujan", icon: "üåßÔ∏è" };
      if (RH > 80 && T >= 27 && T <= 29 && PS >= 1008 && PS <= 1012) return { label: "Hujan Ringan", icon: "üå¶Ô∏è" };
      if (WS > 10.8) return { label: "Berangin", icon: "üå¨Ô∏è" };
      if (T > 30 && RH >= 70) return { label: "Panas Lembap", icon: "ü•µ" };
      if (T > 30 && RH < 60) return { label: "Cerah", icon: "‚òÄÔ∏è" };
      if (RH >= 75 && T < 27) return { label: "Berawan Tebal", icon: "‚òÅÔ∏è" };
      if (T >= 25 && T <= 30 && RH >= 60 && RH <= 85) return { label: "Berawan", icon: "‚õÖ" };

      return { label: "Lainnya", icon: "üå´Ô∏è" };
    }

    function parameterBlockFeatured(labelHuman, valueStr, unit) {
      return `
        <div class="text-center">
          <p class="text-xs text-white/90 mb-1">${labelHuman}</p>
          <p class="text-lg font-bold">${valueStr} ${unit}</p>
        </div>
      `;
    }

    function parameterBlockSmall(icon, labelHuman, valueStr) {
      return `
        <div class="flex items-start justify-between gap-3">
          <p class="text-xs text-gray-500">${icon} ${labelHuman}</p>
          <p class="text-xs font-semibold text-gray-700">${valueStr}</p>
        </div>
      `;
    }

    function renderFeaturedCard(item) {
      const wx = classifyWeather(item);
      const { hari, tanggal } = splitHariTanggal(item.date);

      return `
        <div class="rounded-2xl shadow-lg overflow-hidden">
          <div class="bg-emerald-500 p-6 sm:p-7">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-5">

              <div class="text-white">
                <p class="text-2xl font-bold leading-tight">${hari}</p>
                <p class="text-white/90">${tanggal}</p>
              </div>

              <div class="flex items-center justify-center gap-4">
                <div class="text-5xl">${wx.icon}</div>
                <div class="text-center text-white">
                  <p class="text-4xl font-bold">${safeFixed(item.temperature_c, 1)}¬∞C</p>
                  <p class="text-white/90 text-sm -mt-1">${wx.label}</p>
                </div>
              </div>

              <div class="bg-white/15 rounded-xl p-4 text-white min-w-[320px]">
                <div class="grid grid-cols-3 gap-4 text-center">
                  ${parameterBlockFeatured("Kelembapan", safeFixed(item.humidity_percent, 0), "%")}
                  ${parameterBlockFeatured("Tekanan", safeFixed(item.pressure_hpa, 0), "hPa")}
                  ${parameterBlockFeatured("Angin", safeFixed(item.wind_speed_kmh, 1), "km/h")}
                </div>
              </div>

            </div>
          </div>
        </div>
      `;
    }

    function renderSmallCard(item) {
      const wx = classifyWeather(item);
      const { hari, tanggal } = splitHariTanggal(item.date);

      return `
        <div class="p-5 bg-card rounded-2xl shadow hover:shadow-lg transition">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-bold text-gray-800">${hari}</h3>
              <p class="text-xs text-gray-500">${tanggal}</p>
            </div>
            <div class="text-3xl">${wx.icon}</div>
          </div>

          <div class="mt-3 flex items-end justify-between gap-4">
            <div>
              <p class="text-2xl font-bold text-primary">${safeFixed(item.temperature_c, 1)}¬∞C</p>
              <p class="text-sm text-gray-600">${wx.label}</p>
            </div>

            <div class="flex flex-col gap-2 min-w-[160px]">
              ${parameterBlockSmall("üíß", "RH", `${safeFixed(item.humidity_percent, 0)} %`)}
              ${parameterBlockSmall("üìà", "PS", `${safeFixed(item.pressure_hpa, 0)} hPa`)}
              ${parameterBlockSmall("üå¨Ô∏è", "WS", `${safeFixed(item.wind_speed_kmh, 1)} km/h`)}
            </div>
          </div>
        </div>
      `;
    }

    function renderEvaluationCard(item) {
      return `
        <div class="p-4 bg-gray-50 border rounded-lg text-center">
          <h3 class="font-semibold text-primary mb-1">
            ${String(item.parameter || "").toUpperCase()}
          </h3>
          <p class="text-sm">MSE: ${safeFixed(item.MSE, 3)}</p>
          <p class="text-sm">RMSE: ${safeFixed(item.RMSE, 3)}</p>
          <p class="text-sm">MAE: ${safeFixed(item.MAE, 3)}</p>
          <p class="text-sm font-bold">R¬≤: ${safeFixed(item.R2, 3)}</p>
          <p class="text-[10px] text-gray-400 mt-2">
            Eval date: ${item.eval_date || "-"}
          </p>
        </div>
      `;
    }

    async function loadData() {
      try {
        const forecastRes = await fetch(FORECAST_ENDPOINT);
        const forecastData = await forecastRes.json();
        const sevenDays = forecastData.slice(0, 7);

        featuredEl.innerHTML = renderFeaturedCard(sevenDays[0]);
        forecastGrid.innerHTML = sevenDays.slice(1).map(renderSmallCard).join("");

        const evalRes = await fetch(EVALUATION_ENDPOINT);
        const evalData = await evalRes.json();
        evalCards.innerHTML = evalData.map(renderEvaluationCard).join("");
        evalSection.classList.remove("hidden");

        loadingEl.classList.add("hidden");
      } catch (err) {
        console.error(err);
        loadingEl.classList.add("hidden");
        errorEl.classList.remove("hidden");
      }
    }

    document.addEventListener("DOMContentLoaded", loadData);
  </script>

</body>
</html>
