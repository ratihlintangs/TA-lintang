<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriWeather - Ramalan Cuaca 7 Hari</title>
    <!-- Muat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Tema Tailwind (Opsional, tapi bagus untuk konsistensi) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Warna hijau untuk pertanian
                        'secondary': '#34D399',
                        'background': '#F9FAFB',
                        'card': '#FFFFFF',
                        'accent': '#10B981', // Warna tambahan untuk highlight
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body class="bg-background min-h-screen font-sans p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header dan Lokasi -->
        <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold text-primary mb-2">AgriWeather</h1>
            <p class="text-gray-600 text-lg">Ramalan Cuaca Harian untuk 7 Hari ke Depan (Model MLP Time Series)</p>
            <p class="text-sm font-semibold text-accent mt-3">
                üìç Lokasi Prediksi: Stasiun Klimatologi Karangploso (BMKG)
            </p>
        </header>

        <!-- Container Ramalan Cuaca -->
        <div class="space-y-10">

            <!-- Bagian Ramalan (Forecast) -->
            <section id="forecast-section">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Ramalan 7 Hari Ke Depan</h2>
                <div id="loading-message" class="text-center p-6 bg-blue-100 text-blue-800 rounded-lg shadow-md">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Memuat ramalan cuaca 7 hari...
                </div>
                
                <div id="error-message" class="hidden text-center p-6 bg-red-100 text-red-800 rounded-lg shadow-md">
                    ‚ùå Gagal memuat data ramalan. Pastikan *backend* (FastAPI) sudah berjalan dan model (`.pkl`) tersedia.
                </div>

                <!-- Grid Kartu Prediksi: 3 kolom di desktop, 2 di tablet, 1 di mobile -->
                <div id="forecast-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kartu-kartu prediksi akan dirender di sini -->
                </div>
            </section>

            <!-- Bagian Evaluasi Model -->
            <div id="evaluation-section" class="hidden p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Evaluasi Kinerja Model (RMSE/MAE)</h2>
                <div id="evaluation-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Kartu evaluasi akan dirender di sini -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // Gunakan port 8000 (default FastAPI)
        const API_BASE_URL = 'http://localhost:8000'; 
        // Menggunakan endpoint prediksi
        const FORECAST_ENDPOINT = `${API_BASE_URL}/weather/predict/`; 
        
        const forecastGrid = document.getElementById('forecast-grid');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const evaluationSection = document.getElementById('evaluation-section');
        const evaluationCards = document.getElementById('evaluation-cards');

        /**
         * Fungsi untuk memformat tanggal menjadi 'Hari, Tanggal Bulan Tahun'
         */
        function formatTanggal(dateString) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const date = new Date(dateString);
            // Tambahkan 7 jam untuk mengimbangi perbedaan zona waktu (asumsi WIB/GMT+7)
            date.setHours(date.getHours() + 7); 
            return date.toLocaleDateString('id-ID', options);
        }

        /**
         * Fungsi untuk membuat ikon berdasarkan jenis cuaca (sederhana)
         */
        function getWeatherIcon(temp) {
            if (temp >= 30) {
                return '<span class="text-5xl">‚òÄÔ∏è</span>'; // Panas
            } else if (temp >= 24) {
                return '<span class="text-5xl">‚õÖ</span>'; // Cerah Berawan
            } else {
                return '<span class="text-5xl">üåßÔ∏è</span>'; // Dingin/Hujan (default)
            }
        }

        /**
         * Fungsi untuk merender satu kartu ramalan cuaca
         */
        function renderForecastCard(item, index) {
            const icon = getWeatherIcon(item.temperature_c);
            const formattedDate = formatTanggal(item.date);
            
            // Hari ini (index 0) akan disorot dan mengambil lebar penuh (col-span-full)
            const isFirstDay = index === 0;
            const bgColor = isFirstDay ? 'bg-secondary' : 'bg-card';
            const textColor = isFirstDay ? 'text-white' : 'text-gray-800';
            const subTextColor = isFirstDay ? 'text-gray-200' : 'text-gray-500';
            // lg:col-span-3: Hari pertama mengambil 3 kolom penuh (lebar penuh)
            const colSpan = isFirstDay ? 'lg:col-span-3 sm:col-span-2' : ''; 
            const layoutClass = isFirstDay ? 'flex flex-col md:flex-row items-center justify-between' : 'flex flex-col h-full';


            // Layout untuk Hari Pertama (Lebih Besar, Full Row)
            if (isFirstDay) {
                // *** ADJUSMENT: Menggunakan grid-cols-3 untuk 3 item berjejer rapi ***
                return `
                    <div class="p-8 ${bgColor} rounded-xl shadow-lg transition duration-300 hover:shadow-xl transform hover:-translate-y-1 ${colSpan}">
                        <div class="${layoutClass} w-full">
                            <!-- Kiri: Info Hari -->
                            <div class="md:w-1/3 text-center md:text-left mb-4 md:mb-0">
                                <h2 class="text-3xl font-extrabold ${textColor} mb-1">${formattedDate.split(',')[0]}</h2>
                                <p class="text-base ${subTextColor}">${formattedDate.split(',').slice(1).join(',').trim()}</p>
                            </div>
                            <!-- Tengah: Ikon & Suhu Besar -->
                            <div class="md:w-1/3 text-center mb-4 md:mb-0">
                                ${icon.replace('text-5xl', 'text-7xl')}
                                <p class="text-5xl font-bold ${textColor} mt-2">${item.temperature_c ? item.temperature_c.toFixed(1) : '-'}¬∞C</p>
                                <p class="text-base ${subTextColor}">Suhu Rata-rata Prediksi</p>
                            </div>
                            <!-- Kanan: Detail Lain (Grid 3 Kolom) -->
                            <div class="md:w-1/3 grid grid-cols-3 gap-4 text-sm font-medium p-4 rounded-lg ${isFirstDay ? 'bg-black/10' : 'bg-gray-100'}">
                                
                                <!-- Kelembapan (Kolom 1) -->
                                <div class="${textColor} p-2 rounded-md text-center">
                                    <span class="font-bold block text-2xl">${item.humidity_percent ? item.humidity_percent.toFixed(0) : '-'}%</span>
                                    <span class="${subTextColor} text-xs">Kelembapan</span>
                                </div>
                                
                                <!-- Tekanan (Kolom 2) -->
                                <div class="${textColor} p-2 rounded-md text-center">
                                    <span class="font-bold block text-2xl">${item.pressure_hpa ? item.pressure_hpa.toFixed(0) : '-'} hPa</span>
                                    <span class="${subTextColor} text-xs">Tekanan</span>
                                </div>
                                
                                <!-- Kec. Angin (Kolom 3) -->
                                <div class="${textColor} p-2 rounded-md text-center">
                                    <span class="font-bold block text-2xl">${item.wind_speed_kmh ? item.wind_speed_kmh.toFixed(1) : '-'} km/h</span>
                                    <span class="${subTextColor} text-xs">Kec. Angin</span>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                `;
            }

            // Layout untuk Hari Berikutnya (Normal Card, 6 Hari di bawah) - Tidak Berubah
            return `
                <div class="p-6 ${bgColor} rounded-xl shadow-md transition duration-300 hover:shadow-xl transform hover:-translate-y-0.5 forecast-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold ${textColor} mb-1">${formattedDate.split(',')[0]}</h2>
                            <p class="text-sm ${subTextColor}">${formattedDate.split(',').slice(1).join(',').trim()}</p>
                        </div>
                        <div class="flex-shrink-0">
                            ${icon}
                        </div>
                    </div>

                    <div class="mt-4 border-t pt-4 ${isFirstDay ? 'border-gray-500' : 'border-gray-200'}">
                        <!-- Layout 2x2 dengan Kelembaban dan Kec. Angin di kanan -->
                        <div class="grid grid-cols-2 gap-4 text-sm font-medium">
                            <div class="${textColor}">
                                <span class="font-bold block text-xl">${item.temperature_c ? item.temperature_c.toFixed(1) : '-'}¬∞C</span>
                                <span class="${subTextColor}">Suhu</span>
                            </div>
                            <div class="text-right ${textColor}"> 
                                <span class="font-bold block text-xl">${item.humidity_percent ? item.humidity_percent.toFixed(0) : '-'}%</span>
                                <span class="${subTextColor}">Kelembapan</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm font-medium mt-2">
                            <div class="${textColor}">
                                <span class="font-bold block">${item.pressure_hpa ? item.pressure_hpa.toFixed(0) : '-'} hPa</span>
                                <span class="${subTextColor}">Tekanan</span>
                            </div>
                            <div class="text-right ${textColor}">
                                <span class="font-bold block">${item.wind_speed_kmh ? item.wind_speed_kmh.toFixed(1) : '-'} km/h</span>
                                <span class="${subTextColor}">Kec. Angin</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Fungsi untuk merender kartu evaluasi model
         */
        function renderEvaluationCard(item) {
            return `
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 text-center">
                    <h3 class="text-lg font-semibold text-primary mb-1">${item.target.toUpperCase().replace('_', ' ')}</h3>
                    <p class="text-xs text-gray-500">Model: ${item.model_name}</p>
                    <p class="text-sm font-medium text-gray-700 mt-2">RMSE: <span class="font-bold">${item.rmse.toFixed(2)}</span></p>
                    <p class="text-sm font-medium text-gray-700">MAE: <span class="font-bold">${item.mae.toFixed(2)}</span></p>
                </div>
            `;
        }
        
        /**
         * Fungsi utama untuk mengambil dan menampilkan data ramalan
         */
        async function fetchForecast() {
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            forecastGrid.innerHTML = '';
            evaluationCards.innerHTML = '';
            evaluationSection.classList.add('hidden');

            try {
                const response = await fetch(FORECAST_ENDPOINT);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json(); 
                
                // Pengecekan sederhana bahwa data prediksi yang valid diterima
                if (Array.isArray(result) && result.length > 0) { 
                    loadingMessage.classList.add('hidden');
                    
                    // Render Prediksi Cuaca (Forecast)
                    const forecastHTML = result.map(renderForecastCard).join('');
                    forecastGrid.innerHTML = forecastHTML;
                    
                    console.log("‚úÖ Data Ramalan Berhasil Diterima:", result);
                    
                } else if (result.predictions && result.predictions.length > 0) {
                     // Jika struktur response masih mengandung 'predictions' dan 'evaluations'
                    loadingMessage.classList.add('hidden');
                    const forecastHTML = result.predictions.map(renderForecastCard).join('');
                    forecastGrid.innerHTML = forecastHTML;

                    if (result.evaluations && result.evaluations.length > 0) {
                        const evaluationHTML = result.evaluations.map(renderEvaluationCard).join('');
                        evaluationCards.innerHTML = evaluationHTML;
                        evaluationSection.classList.remove('hidden');
                    }
                    console.log("‚úÖ Data Ramalan Berhasil Diterima:", result);
                }
                else {
                    throw new Error('Data prediksi kosong atau format tidak sesuai.');
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorMessage.textContent = `‚ùå Gagal memuat data ramalan. Detail: ${error.message}. Pastikan backend berjalan di port 8000.`;
            }
        }

        // Jalankan fungsi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            fetchForecast();
        });
    </script>

</body>
</html>