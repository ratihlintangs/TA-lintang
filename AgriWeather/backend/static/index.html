<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriWeather - Prediksi Cuaca Pertanian</title>
    <!-- Memuat Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Lucide Icons untuk ikon cuaca dan navigasi -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Konfigurasi Font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Warna latar belakang abu-abu muda */
        }
        /* Style untuk tablet dan desktop: batasi lebar konten utama */
        .container {
            max-width: 900px;
        }
        /* Styling untuk sel header tabel */
        .header-cell {
            background-color: #d1d5db; /* Abu-abu sedang untuk header */
            color: #1f2937; /* Teks gelap */
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: center;
        }
        /* Styling untuk sel data tabel */
        .data-cell {
            background-color: #e5e7eb; /* Abu-abu sangat muda untuk data */
            color: #374151; /* Teks abu-abu gelap */
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="container mx-auto">
        <!-- Main Card Area -->
        <div class="bg-stone-300 p-4 sm:p-6 rounded-3xl shadow-xl">

            <!-- Header Title -->
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">AgriWeather</h1>
                <p id="today-date" class="text-lg text-gray-700 mt-1">Hari Ini: Loading...</p>
            </header>

            <!-- Current Day Overview (Top Section) -->
            <div id="current-weather" class="bg-gray-200 p-6 rounded-2xl shadow-inner mb-6 flex flex-col sm:flex-row items-center justify-between relative">
                
                <!-- Navigation Arrows (Placeholder) -->
                <button class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-600 hover:text-gray-800 transition duration-150 p-2 sm:hidden">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <button class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-600 hover:text-gray-800 transition duration-150 p-2 sm:hidden">
                    <i data-lucide="arrow-right" class="w-6 h-6"></i>
                </button>

                <!-- Icon and Temperature -->
                <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                    <!-- Icon placeholder (Kita simpan ikon, meski fokus pada data) -->
                    <div id="current-icon" class="text-6xl text-yellow-500">
                         <i data-lucide="sun" class="w-16 h-16"></i>
                    </div>
                    <div class="flex items-start">
                        <span id="current-temp" class="text-6xl font-extrabold text-gray-800">--</span>
                        <span class="text-4xl text-gray-600 font-bold mt-1">°C</span>
                    </div>
                    <!-- Kita ganti deskripsi cuaca menjadi Tekanan Sistem -->
                    <span id="current-pressure" class="text-xl text-gray-700 font-medium">Tekanan: -- hPa</span>
                </div>

                <!-- Details (Humidity, Wind Speed) -->
                <div class="text-lg text-gray-700 space-y-1 sm:text-right">
                    <p>Kelembapan: <span id="current-humidity" class="font-semibold">--%</span></p>
                    <p>Kecepatan Angin: <span id="current-wind" class="font-semibold">-- Km/j</span></p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-spinner" class="text-center p-8 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <p class="mt-4 text-gray-700">Mengambil dan memproses prediksi dari 4 model AR...</p>
            </div>
            
            <!-- Error State -->
            <div id="error-message" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg hidden" role="alert">
                <p class="font-bold">Gagal Memuat Data</p>
                <p id="error-detail">Terjadi kesalahan saat menghubungi API. Pastikan backend Anda berjalan di http://127.0.0.1:8000.</p>
            </div>

            <!-- Forecast Table (Bottom Section) -->
            <div id="forecast-table-container" class="overflow-x-auto shadow-lg rounded-xl border border-gray-300 hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr id="table-day-headers">
                            <th class="header-cell sticky left-0 z-10 w-[100px] text-xs sm:text-base">Minggu (Tanggal)</th>
                            <!-- Days will be dynamically inserted here -->
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="row-temp">
                            <td class="header-cell sticky left-0 z-10 font-normal text-sm sm:text-base bg-stone-300">Suhu (°C)</td>
                            <!-- Data cells -->
                        </tr>
                        <!-- BARIS BARU: Tekanan Sistem -->
                        <tr id="row-pressure">
                            <td class="header-cell sticky left-0 z-10 font-normal text-sm sm:text-base bg-stone-300">Tekanan (hPa)</td>
                            <!-- Data cells -->
                        </tr>
                        <tr id="row-humidity">
                            <td class="header-cell sticky left-0 z-10 font-normal text-sm sm:text-base bg-stone-300">Kelembapan (%)</td>
                            <!-- Data cells -->
                        </tr>
                        <tr id="row-wind">
                            <td class="header-cell sticky left-0 z-10 font-normal text-sm sm:text-base bg-stone-300">Kecepatan Angin (Km/j)</td>
                            <!-- Data cells -->
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
        
        <!-- Footer / Model Information -->
        <footer class="text-center mt-6 text-sm text-gray-600">
            <p>Aplikasi TA AgriWeather. Model Prediksi: <span id="model-info">4x AR Model V1.0 (Lags=5)</span></p>
        </footer>

    </div>

    <script>
        // Inisialisasi Lucide Icons setelah konten dimuat
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchWeatherData();
        });

        const API_URL = 'http://127.0.0.1:8000/weather/predict/';
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const forecastTableContainer = document.getElementById('forecast-table-container');
        const modelInfoSpan = document.getElementById('model-info');

        // Fungsi untuk menentukan hari dalam seminggu dalam bahasa Indonesia
        const daysInIndonesian = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

        // --- Ikon Cuaca Mock (Simulasi) ---
        const getWeatherIconAndDescription = (temperature, humidity) => {
            if (temperature >= 32 && humidity < 70) {
                return { icon: 'sun', color: 'text-yellow-500' };
            } else if (temperature >= 30 && humidity >= 80) {
                return { icon: 'cloud-sun', color: 'text-yellow-600' };
            } else if (temperature < 30 && humidity >= 85) {
                return { icon: 'cloud-rain', color: 'text-blue-500' };
            } else if (humidity > 90) {
                 return { icon: 'cloud-lightning', color: 'text-indigo-600' };
            } else if (temperature < 28) {
                return { icon: 'wind', color: 'text-gray-500' };
            } else {
                return { icon: 'cloud-sun', color: 'text-yellow-600' };
            }
        };

        const renderIcon = (iconName, size = 48) => {
            const iconElement = lucide.createIcons()[iconName];
            if (iconElement) {
                iconElement.setAttribute('width', size);
                iconElement.setAttribute('height', size);
                return iconElement.outerHTML;
            }
            return '';
        };

        // --- Fungsi Utama: Mengambil Data dan Merender UI ---
        async function fetchWeatherData() {
            loadingSpinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            forecastTableContainer.classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}?days_ahead=7`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const predictions = await response.json();

                if (predictions.length === 0) {
                    document.getElementById('error-detail').textContent = "API berhasil dipanggil, tetapi tidak mengembalikan data prediksi. Pastikan database Anda memiliki data historis yang cukup.";
                    errorMessage.classList.remove('hidden');
                    return;
                }

                // Update info model di footer (mengambil dari data pertama jika tersedia)
                if (predictions[0] && predictions[0].model) {
                     modelInfoSpan.textContent = predictions[0].model;
                }
                
                // 1. Render Cuaca Hari Ini (Data Pertama dari Prediksi)
                const todayData = predictions[0];
                renderCurrentWeather(todayData);
                
                // 2. Render Tabel Prediksi 7 Hari
                renderForecastTable(predictions);

            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('error-detail').textContent = `Kesalahan jaringan/server: ${error.message}. Pastikan backend FastAPI Anda berjalan di http://127.0.0.1:8000.`;
                errorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        function renderCurrentWeather(data) {
            const today = new Date();
            const dateStr = today.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            document.getElementById('today-date').textContent = `Hari Ini: ${dateStr}`;

            // Menggunakan ikon berdasarkan simulasi (jika Anda ingin mempertahankannya)
            const { icon, color } = getWeatherIconAndDescription(data.temperature, data.humidity);
            document.getElementById('current-icon').innerHTML = `<i data-lucide="${icon}" class="${color} w-16 h-16"></i>`;
            
            document.getElementById('current-temp').textContent = Math.round(data.temperature);
            // MEMPERBARUI: Menggunakan Tekanan (Pressure) untuk slot deskripsi
            document.getElementById('current-pressure').textContent = `Tekanan: ${data.pressure.toFixed(2)} hPa`;
            document.getElementById('current-humidity').textContent = `${Math.round(data.humidity)}%`;
            document.getElementById('current-wind').textContent = `${data.wind_speed.toFixed(1)} Km/j`;
            
            // Re-create icons for the current section
            lucide.createIcons({ attr: 'data-lucide', classes: 'w-6 h-6', parent: document.getElementById('current-weather') });
        }

        function renderForecastTable(predictions) {
            const headerRow = document.getElementById('table-day-headers');
            const tempRow = document.getElementById('row-temp');
            const pressureRow = document.getElementById('row-pressure'); // Baris Tekanan Baru
            const humidityRow = document.getElementById('row-humidity');
            const windRow = document.getElementById('row-wind');

            // Hapus header dan data lama
            headerRow.querySelectorAll('.day-header').forEach(el => el.remove());
            tempRow.querySelectorAll('.data-cell').forEach(el => el.remove());
            pressureRow.querySelectorAll('.data-cell').forEach(el => el.remove()); // Hapus data Tekanan lama
            humidityRow.querySelectorAll('.data-cell').forEach(el => el.remove());
            windRow.querySelectorAll('.data-cell').forEach(el => el.remove());
            
            // Tampilkan tabel
            forecastTableContainer.classList.remove('hidden');

            predictions.forEach((data, index) => {
                const dateObj = new Date(data.date);
                const dayName = daysInIndonesian[dateObj.getDay()];
                
                // Header Hari
                const dayHeaderCell = document.createElement('th');
                dayHeaderCell.className = 'header-cell day-header text-sm sm:text-base';
                dayHeaderCell.textContent = index === 0 ? 'Hari Ini' : dayName;
                headerRow.appendChild(dayHeaderCell);

                // Suhu
                const tempCell = document.createElement('td');
                tempCell.className = 'data-cell';
                tempCell.textContent = Math.round(data.temperature);
                tempRow.appendChild(tempCell);

                // Tekanan (Pressure) - BARIS BARU
                const pressureCell = document.createElement('td');
                pressureCell.className = 'data-cell';
                pressureCell.textContent = data.pressure.toFixed(2);
                pressureRow.appendChild(pressureCell);
                
                // Kelembapan
                const humidityCell = document.createElement('td');
                humidityCell.className = 'data-cell';
                humidityCell.textContent = `${Math.round(data.humidity)}%`;
                humidityRow.appendChild(humidityCell);

                // Kecepatan Angin
                const windCell = document.createElement('td');
                windCell.className = 'data-cell';
                windCell.textContent = data.wind_speed.toFixed(1);
                windRow.appendChild(windCell);
            });
            
            lucide.createIcons();
        }
        
    </script>
</body>
</html>